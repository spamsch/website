---
import { readAll } from "@local/shared/markdoc/read";
import { blog } from "@local/shared/markdoc/frontmatter.schema";
import PageLayout from "../layouts/PageLayout.astro";
import PageMeta from "../components/PageMeta.astro";
import { SITE_TITLE } from "../config";

const posts = await readAll({
  directory: "blog",
  frontmatterSchema: blog,
});

const sortedPosts = posts
  .filter((p) => p.frontmatter.draft !== true)
  .sort((a, b) => a.frontmatter.order - b.frontmatter.order);

const allTags = [...new Set(sortedPosts.flatMap((p) => p.frontmatter.tags ?? []))].sort();

function tagClass(tag: string): string {
  return "tag-" + tag.replace(/\//g, "-").toLowerCase();
}
---

<PageLayout>
  <PageMeta title={`Blog | ${SITE_TITLE}`} slot="meta" />
  <section slot="main">
    <div class="mb-8 text-text-normal">
      <p>
        I use this space to unpack the work I lead—large-scale platforms, hardware-plus-software builds,
        AI memory systems—as well as the technical ideas I keep tinkering with. Expect opinionated lessons
        learned, detailed architecture notes, and the occasional musing about where tech is headed next.
      </p>
    </div>
    <div class="tag-filter-bar mb-6">
      <button class="tag-pill tag-filter-btn active" data-tag="">All</button>
      {allTags.map((tag) => (
        <button class={`tag-pill tag-filter-btn ${tagClass(tag)}`} data-tag={tag}>
          {tag}
        </button>
      ))}
    </div>
    <ul class="blog-list">
      {
        sortedPosts.map((post) => {
          const tags = post.frontmatter.tags ?? [];
          return (
            <li class="mb-6 blog-list-item" data-tags={tags.join(",")}>
              <div class="title blog-list-title">
                {post.frontmatter.external ? (
                  <a
                    href={post.frontmatter.url}
                    target="_blank"
                    class="unset hover:text-text-link"
                  >
                    <span>{post.frontmatter.title}</span>
                    <span>
                      <i class="ml-1 mr-1 text-[12px] pb-2 fa-solid fa-up-right-from-square pt-1" />
                    </span>
                  </a>
                ) : (
                  <a
                    href={`/blog/${post.slug}`}
                    class="unset hover:text-text-link"
                  >
                    {post.frontmatter.title}
                  </a>
                )}
              </div>
              {tags.length > 0 && (
                <div class="blog-tags-line mt-2">
                  {tags.map((tag) => (
                    <span class={`tag-pill ${tagClass(tag)}`} style="padding: 0.1rem 0.5rem; border-radius: 9999px; border-width: 1px; font-size: 0.65rem;">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
              {post.frontmatter.description && (
                <p class="mt-2 text-sm text-text-muted leading-relaxed">
                  {post.frontmatter.description}
                </p>
              )}
            </li>
          );
        })
      }
    </ul>
  </section>
</PageLayout>

<script>
  document.addEventListener("astro:page-load", () => {
    const buttons = document.querySelectorAll<HTMLButtonElement>(".tag-filter-btn");
    const items = document.querySelectorAll<HTMLLIElement>(".blog-list-item");

    function applyFilter(tag: string) {
      buttons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tag === tag);
      });
      items.forEach((item) => {
        if (!tag) {
          item.style.display = "";
          return;
        }
        const itemTags = (item.dataset.tags ?? "").split(",");
        item.style.display = itemTags.includes(tag) ? "" : "none";
      });
    }

    // Restore filter from URL
    const params = new URLSearchParams(window.location.search);
    const initialTag = params.get("tag") ?? "";
    applyFilter(initialTag);

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.dataset.tag ?? "";
        const currentTag = new URLSearchParams(window.location.search).get("tag") ?? "";

        // Toggle off if clicking the already-active tag
        const newTag = tag === currentTag ? "" : tag;

        if (newTag) {
          const url = new URL(window.location.href);
          url.searchParams.set("tag", newTag);
          history.pushState({}, "", url);
        } else {
          const url = new URL(window.location.href);
          url.searchParams.delete("tag");
          history.pushState({}, "", url);
        }

        applyFilter(newTag);
      });
    });
  });
</script>

<style>
  .tag-filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .tag-filter-btn {
    padding: 0.2rem 0.7rem;
    border-radius: 9999px;
    border-width: 1px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.15s ease;
  }
</style>
